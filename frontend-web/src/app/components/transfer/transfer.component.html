<div class="transfer-page">
  <app-sidebar></app-sidebar>

  <div class="transfer-content">
    <div class="page-header">
      <h1>Effectuer un Virement</h1>
      <p>Transférez de l'argent de manière sécurisée</p>
    </div>

    <!-- Stepper -->
    <div class="stepper-container">
      <div class="stepper">
        <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
          <div class="step-circle">
            @if (currentStep > 1) {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="20 6 9 17 4 12" stroke-width="3"/>
              </svg>
            } @else {
              <span>1</span>
            }
          </div>
          <div class="step-label">Informations</div>
        </div>

        <div class="step-line" [class.active]="currentStep >= 2"></div>

        <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
          <div class="step-circle">
            @if (currentStep > 2) {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="20 6 9 17 4 12" stroke-width="3"/>
              </svg>
            } @else {
              <span>2</span>
            }
          </div>
          <div class="step-label">Confirmation</div>
        </div>

        <div class="step-line" [class.active]="currentStep >= 3"></div>

        <div class="step" [class.active]="currentStep >= 3">
          <div class="step-circle">
            <span>3</span>
          </div>
          <div class="step-label">Résultat</div>
        </div>
      </div>
    </div>

    <!-- Step 1: Informations -->
    @if (currentStep === 1) {
      <div class="transfer-card">
        <h2 class="card-title">Type de virement</h2>
        
        <div class="transfer-type-selector">
          <button 
            type="button"
            class="transfer-type-card" 
            [class.selected]="transferType === 'INTERNAL'"
            (click)="selectTransferType('INTERNAL')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke-width="2"/>
              <polyline points="9 22 9 12 15 12 15 22" stroke-width="2"/>
            </svg>
            <div class="transfer-type-content">
              <h3>Virement Interne</h3>
              <p>Entre comptes WillBank</p>
            </div>
          </button>

          <button 
            type="button"
            class="transfer-type-card" 
            [class.selected]="transferType === 'EXTERNAL'"
            (click)="selectTransferType('EXTERNAL')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10" stroke-width="2"/>
              <line x1="2" y1="12" x2="22" y2="12" stroke-width="2"/>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke-width="2"/>
            </svg>
            <div class="transfer-type-content">
              <h3>Virement Externe</h3>
              <p>Vers une autre banque</p>
            </div>
          </button>
        </div>

        <form class="transfer-form">
          <div class="form-group">
            <label for="sourceAccountId">Compte source <span class="required">*</span></label>
            <select 
              id="sourceAccountId" 
              name="sourceAccountId" 
              [(ngModel)]="transfer.sourceAccountId" 
              class="form-control">
              <option value="0">Sélectionnez un compte</option>
              @for (account of accounts; track account.id) {
                <option [value]="account.id">{{ getAccountLabel(account) }}</option>
              }
            </select>
          </div>

          @if (transferType === 'INTERNAL') {
            <div class="form-group">
              <label for="destinationAccountId">Compte destinataire <span class="required">*</span></label>
              <select 
                id="destinationAccountId" 
                name="destinationAccountId" 
                [(ngModel)]="transfer.destinationAccountId" 
                class="form-control">
                <option value="0">Sélectionnez un compte</option>
                @for (account of getAvailableDestinationAccounts(); track account.id) {
                  <option [value]="account.id">{{ getAccountLabel(account) }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="form-group">
              <label for="externalIban">Compte destinataire <span class="required">*</span></label>
              <input 
                type="text" 
                id="externalIban" 
                name="externalIban" 
                [(ngModel)]="externalIban" 
                class="form-control" 
                placeholder="FR76 XXXX XXXX XXXX XXXX XXXX XXX" />
            </div>
          }

          <div class="form-group">
            <label for="amount">Montant <span class="required">*</span></label>
            <div class="input-with-suffix">
              <input 
                type="number" 
                id="amount" 
                name="amount" 
                [(ngModel)]="transfer.amount" 
                class="form-control" 
                placeholder="0.00"
                min="0" 
                step="0.01" />
              <span class="input-suffix">€</span>
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description (optionnel)</label>
            <textarea 
              id="description" 
              name="description" 
              [(ngModel)]="transfer.description" 
              class="form-control" 
              rows="3" 
              placeholder="Motif du virement..."></textarea>
          </div>

          @if (transferType === 'INTERNAL') {
            <div class="info-box">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <path d="M12 16v-4M12 8h.01" stroke-width="2"/>
              </svg>
              <div>
                <strong>Les virements internes WillBank sont instantanés.</strong>
                <p>Les virements externes peuvent prendre 1 à 3 jours ouvrables.</p>
              </div>
            </div>
          }
        </form>

        @if (error) {
          <div class="alert alert-error">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10" stroke-width="2"/>
              <line x1="15" y1="9" x2="9" y2="15" stroke-width="2"/>
              <line x1="9" y1="9" x2="15" y2="15" stroke-width="2"/>
            </svg>
            {{ error }}
          </div>
        }

        <div class="transfer-actions">
          <button type="button" class="btn btn-outline" (click)="goToTransactions()">
            Annuler
          </button>
          <button type="button" class="btn btn-primary" (click)="nextStep()">
            Continuer
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <line x1="5" y1="12" x2="19" y2="12" stroke-width="2"/>
              <polyline points="12 5 19 12 12 19" stroke-width="2"/>
            </svg>
          </button>
        </div>
      </div>
    }

    <!-- Step 2: Confirmation -->
    @if (currentStep === 2) {
      <div class="transfer-card">
        <div class="alert alert-warning">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10" stroke-width="2"/>
            <path d="M12 16v-4M12 8h.01" stroke-width="2"/>
          </svg>
          Veuillez vérifier les informations avant de confirmer le virement
        </div>

        <div class="confirmation-details">
          <div class="detail-row">
            <span class="detail-label">Type de virement</span>
            <span class="detail-value">{{ transferType === 'INTERNAL' ? 'Virement Interne' : 'Virement Externe' }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Compte source</span>
            <span class="detail-value">{{ getSourceAccount()?.accountNumber || 'Compte Courant' }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Compte destinataire</span>
            <span class="detail-value">{{ getDestinationDisplay() || 'h' }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Montant</span>
            <span class="detail-value amount">{{ transfer.amount.toFixed(2) }} €</span>
          </div>

          @if (transfer.description) {
            <div class="detail-row">
              <span class="detail-label">Description</span>
              <span class="detail-value">{{ transfer.description || 'h' }}</span>
            </div>
          }

          <div class="total-box">
            <span class="total-label">Total à débiter</span>
            <span class="total-amount">{{ transfer.amount.toFixed(2) }} €</span>
          </div>
        </div>

        @if (error) {
          <div class="alert alert-error">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10" stroke-width="2"/>
              <line x1="15" y1="9" x2="9" y2="15" stroke-width="2"/>
              <line x1="9" y1="9" x2="15" y2="15" stroke-width="2"/>
            </svg>
            {{ error }}
          </div>
        }

        <div class="transfer-actions">
          <button type="button" class="btn btn-outline" (click)="previousStep()">
            Retour
          </button>
          <button type="button" class="btn btn-primary" (click)="confirmTransfer()" [disabled]="loading">
            {{ loading ? 'Traitement...' : 'Confirmer le virement' }}
          </button>
        </div>
      </div>
    }

    <!-- Step 3: Résultat -->
    @if (currentStep === 3) {
      <div class="transfer-card success-card">
        <div class="success-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10" stroke-width="2"/>
            <polyline points="8 12 11 15 16 9" stroke-width="2"/>
          </svg>
        </div>

        <h2 class="success-title">Virement effectué avec succès !</h2>
        <p class="success-message">Votre virement a été traité</p>

        <div class="confirmation-details">
          <div class="detail-row">
            <span class="detail-label">Référence</span>
            <span class="detail-value">{{ transferReference }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Date</span>
            <span class="detail-value">{{ transferDate }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Montant</span>
            <span class="detail-value amount">{{ transfer.amount.toFixed(2) }} €</span>
          </div>
        </div>

        <div class="transfer-actions">
          <button type="button" class="btn btn-primary" (click)="newTransfer()">
            Nouveau virement
          </button>
          <button type="button" class="btn btn-outline" (click)="goToDashboard()">
            Retour au tableau de bord
          </button>
        </div>
      </div>
    }
  </div>
</div>
